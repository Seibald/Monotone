<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Jeu en cours</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const socket = io();

            const room = "{{ room }}";
            socket.emit('join', { room: room, hero: "{{ session.get('hero', 'Héros 1') }}" });

            socket.on('start_game', (game) => {
                updateGame(game);
            });

            socket.on('update_game', (game) => {
                updateGame(game);
            });

            const updateGame = (game) => {
                // Update the game state on the page
                document.getElementById('turn').innerText = `Tour ${game.turn}`;
                document.getElementById('current_player').innerText = `C'est au ${game.current_player === 'player1' ? 'Joueur 1' : 'Joueur 2'} de jouer.`;
                document.getElementById('player1_status').innerText = `Joueur 1 - PV: ${game.players.player1.pv} - Blasées: ${game.players.player1.blase_count} - Dégâts de Réveil: ${game.players.player1.degats_de_reveil}`;
                document.getElementById('player2_status').innerText = `Joueur 2 - PV: ${game.players.player2.pv} - Blasées: ${game.players.player2.blase_count} - Dégâts de Réveil: ${game.players.player2.degats_de_reveil}`;
            };

            document.getElementById('playCard').addEventListener('submit', (e) => {
                e.preventDefault();
                const card = document.querySelector('input[name="card"]:checked').value;
                const target = document.querySelector('input[name="target"]:checked').value;
                socket.emit('play_card', { room: room, card: card, target: target });
            });
        });
    </script>
</head>
<body>
    <h1 id="turn">Tour {{ turn }}</h1>
    <h2 id="current_player">C'est au {{ 'Joueur 1' if current_player_key == 'player1' else 'Joueur 2' }} de jouer.</h2>
    <h3>État des joueurs :</h3>
    <p id="player1_status">Joueur 1 - PV: {{ player1.pv }} - Blasées: {{ player1.blase_count }} - Dégâts de Réveil: {{ player1.degats_de_reveil }}</p>
    <p id="player2_status">Joueur 2 - PV: {{ player2.pv }} - Blasées: {{ player2.blase_count }} - Dégâts de Réveil: {{ player2.degats_de_reveil }}</p>
    {% if last_card %}
    <h3>Carte piochée :</h3>
    <img src="{{ url_for('static', filename='images/' + last_card.replace(' ', '_') + '.png') }}" alt="{{ last_card }}">
    {% endif %}
    <h3>Choisissez une action :</h3>
    <form id="playCard">
        <input type="radio" name="card" value="eveillez" required> Éveiller<br>
        <input type="radio" name="card" value="blasez" required> Blaser<br>
        {% if last_card in ["OUBLI 2", "BLAZ 2"] %}
        <p>Choisissez une cible :</p>
        <input type="radio" name="target" value="self" required> Vous-même<br>
        <input type="radio" name="target" value="opponent" required> L'adversaire<br>
        {% endif %}
        <button type="submit">Valider</button>
    </form>
</body>
</html>